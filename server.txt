FROM centos as base

# base：基本命令和配置yum源
RUN mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup \
	&& curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo \
	&& yum clean all && yum makecache \
	&& yum -y install epel-release sudo vim

# nodejs：安装nodejs和cnpm
From base as nodejs
RUN curl --silent --location https://rpm.nodesource.com/setup_8.x | sudo bash - \
	&& yum -y install nodejs \
	&& npm install -g cnpm --registry=https://registry.npm.taobao.org


# webServer：使用npm安装相关依赖，并安装express初始项目
From nodejs as webServer
WORKDIR /home/myapp
RUN yum -y install gcc gcc-c++ make \
	&& cnpm install node-gyp -g \
	&& cnpm install ccap \
	&& cnpm install body-parser@1.18.2 \
	&& cnpm install cookie-parser@1.4.3 \
	&& cnpm install cors@2.8.4 \
	&& cnpm install debug@2.6.9 \
	&& cnpm install ejs@2.5.7 \
	&& cnpm install express@4.15.5 \
	&& cnpm install formidable@1.1.1 \
	&& cnpm install htmlparser2@3.9.2 \
	&& cnpm install log4js@2.5.3 \
	&& cnpm install moment@2.20.1 \
	&& cnpm install morgan@1.9.0 \
	&& cnpm install serve-favicon@2.4.5 \
	&& cnpm install xml-mapping@1.7.1 \
	&& cnpm install xmlreader@0.2.3 \
	&& cnpm install express-generator -g \
	&& cd .. && express --view=ejs -f myapp \
	&& cd myapp
CMD ["npm", "start"]